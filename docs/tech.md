# Техническая документация Telegram-бота "Фитнес-Навигатор"

## 1. Технический стек

- **Язык:** Python 3.11+
- **Telegram Framework:** `aiogram` 3.x (современный, асинхронный, на базе `Router`).
- **ORM (Работа с БД):** `Tortoise ORM` (асинхронная, интуитивно понятная).
- **База данных:** `SQLite` (файловая, не требует установки сервера, подходит для MVP).
- **Конфигурация:** `pydantic-settings` или чтение `.env` файла.
- **Миграции:** `aerich` (для работы с Tortoise ORM).

## 2. Модель данных (Схема БД)

### Таблица `User`
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID / AutoField | Primary Key |
| `telegram_id` | BigInt | Уникальный ID пользователя Telegram |
| `username` | String | Никнейм пользователя (опционально) |
| `first_name` | String | Имя пользователя |
| `goal` | Text | Главная цель пользователя (из онбординга) |
| `limitations` | Text | Ограничения (травмы, хронические состояния, из онбординга) |
| `work_schedule` | String | Режим дня / рабочий график (из онбординга) |
| `onboarding_completed` | Boolean | Завершён ли онбординг |
| `created_at` | Datetime | Дата регистрации |

### Таблица `DailyCheckin`
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID / AutoField | Primary Key |
| `user` | ForeignKey | Ссылка на таблицу `User` |
| `body_state` | Int | Состояние тела (1-10) |
| `available_time` | Int | Доступное время в минутах |
| `mood` | Int | Настрой к активности (1-10) |
| `suggested_action` | String | Предложенное действие (тренировка/восстановление/отдых) |
| `action_details` | Text | Детали действия (тип тренировки, продолжительность и т.д.) |
| `action_completed` | Boolean | Выполнено ли действие (опционально, может быть Null) |
| `checkin_date` | Date | Дата чек-ина (для группировки и статистики) |
| `created_at` | Datetime | Дата и время создания записи |

## 3. Структура проекта

Проект организован для удобной навигации (Context-First Architecture):

```text
voronka-my-fitness-bot/
├── .env                # Токены и секреты
├── .env.example        # Пример конфигурации
├── .gitignore
├── requirements.txt
├── README.md
├── AGENTS.md           # Инструкция для AI-агентов
├── docs/
│   ├── product.md      # Продуктовая документация
│   ├── tech.md         # Техническая документация (этот файл)
│   └── README.md       # Навигация по документации
├── plans/
│   └── 001-master-plan.md  # План реализации MVP
├── migrations/         # Миграции Aerich (генерируются автоматически)
├── src/
│   └── fitness_navigator/
│       ├── main.py             # Точка входа
│       ├── config.py           # Конфигурация (чтение .env)
│       ├── database/
│       │   ├── __init__.py
│       │   ├── models.py       # Описание таблиц (User, DailyCheckin)
│       │   └── core.py         # Инициализация БД
│       ├── handlers/
│       │   ├── __init__.py
│       │   ├── common.py       # Роутер базовых команд (/start, онбординг)
│       │   ├── checkin.py      # Роутер чек-инов (/checkin)
│       │   └── stats.py        # Роутер статистики (/stats)
│       ├── services/
│       │   ├── __init__.py
│       │   ├── decision_engine.py  # Движок принятия решений (правила из product.md)
│       │   ├── stats_calculator.py # Расчёт статистики
│       │   └── insights.py         # Генератор смысловых инсайтов
│       └── keyboards/
│           ├── __init__.py
│           ├── common.py       # Общие клавиатуры (числа 1-10, да/нет)
│           └── checkin.py      # Клавиатуры для чек-инов
└── temp/               # Временные файлы (если понадобятся)
```

## 4. Основные компоненты

### 4.1 Handlers (Обработчики команд)

- **`common.py`**: 
  - `/start` — приветствие и начало онбординга
  - Онбординг (сбор целей, ограничений, графика)

- **`checkin.py`**: 
  - `/checkin` — инициация ежедневного чек-ина
  - FSM для сбора данных (состояние тела, время, настрой)
  - Отправка предложенного действия
  - Фиксация выполнения действия

- **`stats.py`**: 
  - `/stats` — показ статистики за 7/30 дней
  - Инсайты и тренды

### 4.2 Services (Бизнес-логика)

- **`decision_engine.py`**: 
  - Принимает параметры чек-ина (body_state, available_time, mood)
  - Учитывает ограничения пользователя из онбординга
  - Применяет правила принятия решений (см. product.md, раздел 7)
  - Возвращает предложенное действие (тренировка/восстановление/отдых) с деталями

- **`stats_calculator.py`**: 
  - Получение чек-инов за период
  - Расчёт регулярности
  - Распределение по типам действий
  - Средние значения параметров

- **`insights.py`**: 
  - Анализ паттернов (когда больше энергии, когда меньше)
  - Генерация коротких смысловых инсайтов
  - Форматирование статистики для пользователя

### 4.3 Keyboards (Клавиатуры)

- **`common.py`**: 
  - Числовые клавиатуры (1-10 для состояний)
  - Да/Нет клавиатуры

- **`checkin.py`**: 
  - Клавиатуры для выбора времени
  - Клавиатуры для подтверждения/изменения действия

## 5. FSM (Finite State Machine) для чек-инов

Используется `aiogram` FSM для многошагового сбора данных чек-ина:

```python
class CheckinStates(StatesGroup):
    waiting_body_state = State()      # Ожидание состояния тела (1-10)
    waiting_available_time = State()  # Ожидание доступного времени
    waiting_mood = State()            # Ожидание настроя (1-10)
    confirming_action = State()       # Подтверждение предложенного действия
```

## 6. Правила принятия решений (Decision Engine)

Логика реализуется в `services/decision_engine.py` на основе правил из `docs/product.md`, раздел 7:

- Учитываются все три параметра: `body_state`, `available_time`, `mood`
- Учитываются ограничения пользователя (`limitations`)
- Применяются простые правила (если-то-иначе)
- Возвращается действие с деталями (тип, продолжительность, описание)

## 7. Зависимости (requirements.txt)

```
aiogram==3.x
tortoise-orm==0.20.0
aerich==0.7.2
python-dotenv==1.0.0
pydantic-settings==2.0.0
```

## 8. Конфигурация (.env)

```
BOT_TOKEN=your_telegram_bot_token_here
DATABASE_URL=sqlite://./db.sqlite3
```

## 9. Замечания по архитектуре

- **Асинхронность:** Весь I/O (база данных, запросы к Telegram) должен быть асинхронным (`async`/`await`).
- **Простота:** MVP фокус — избегать оверинжиниринга. Простые решения, соответствующие стеку.
- **Расширяемость:** Структура позволяет легко добавлять новые хендлеры, сервисы и правила.