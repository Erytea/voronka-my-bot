# План реализации MVP "Фитнес-Навигатор"

**Цель:** Реализация Telegram-бота "Фитнес-Навигатор" с функционалом онбординга, ежедневных чек-инов, предложения действий на основе состояния пользователя и статистики, согласно продуктовой и технической документации.

## Этапы реализации (Proposed Steps)

### Этап 1: Инициализация и инфраструктура
1.  Настройка окружения:
    *   Создать `requirements.txt` с зависимостями (`aiogram`, `tortoise-orm`, `aerich`, `python-dotenv`, `pydantic-settings`).
    *   Создать `.env.example` и `.env` (добавить в `.gitignore`).
    *   Создать `README.md` с описанием проекта и инструкциями по запуску.
2.  Создать структуру проекта согласно `docs/tech.md`:
    *   `src/fitness_navigator/database/`, `src/fitness_navigator/handlers/`, `src/fitness_navigator/services/`, `src/fitness_navigator/keyboards/`.
    *   Создать все `__init__.py` файлы.

### Этап 2: База данных (Tortoise ORM)
3.  Реализовать модели данных в `src/fitness_navigator/database/models.py`:
    *   `User` (telegram_id, username, first_name, goal, limitations, work_schedule, onboarding_completed, created_at).
    *   `DailyCheckin` (user FK, body_state, available_time, mood, suggested_action, action_details, action_completed, checkin_date, created_at).
4.  Настроить инициализацию БД в `src/fitness_navigator/database/core.py`.
5.  Настроить и инициализировать `aerich` (миграции):
    *   Создать конфигурацию `aerich.ini` (или через pyproject).
    *   Сгенерировать и применить первую миграцию (`init-db`).

### Этап 3: Базовая логика бота
6.  Создать `src/fitness_navigator/config.py`:
    *   Чтение `.env` файла.
    *   Конфигурация для бота и БД.
7.  Создать точку входа `src/fitness_navigator/main.py`:
    *   Настройка `Bot` и `Dispatcher`.
    *   Подключение жизненного цикла БД (startup/shutdown).
    *   Базовая структура для подключения роутеров.

### Этап 4: Онбординг (Onboarding)
8.  Реализовать клавиатуры в `src/fitness_navigator/keyboards/common.py`:
    *   Числовые клавиатуры (1-10).
    *   Да/Нет клавиатуры.
9.  Реализовать `src/fitness_navigator/handlers/common.py`:
    *   Создать `Router`.
    *   Зарегистрировать хендлер `/start` через роутер.
    *   Логика регистрации пользователя (создание записи в таблице `User`, если нет).
    *   FSM для онбординга (сбор: цель, ограничения, режим дня).
    *   Подключить роутер `common` в `main.py` через `dp.include_router()`.

### Этап 5: Ежедневный чек-ин (Daily Checkin)
10. Реализовать `src/fitness_navigator/services/decision_engine.py`:
    *   Функция принятия решений на основе правил из `docs/product.md` (раздел 7).
    *   Учет параметров чек-ина (body_state, available_time, mood).
    *   Учет ограничений пользователя из онбординга.
    *   Возврат предложенного действия с деталями.
11. Реализовать клавиатуры для чек-инов в `src/fitness_navigator/keyboards/checkin.py`:
    *   Клавиатуры для выбора времени.
    *   Клавиатуры для подтверждения действия.
12. Реализовать `src/fitness_navigator/handlers/checkin.py`:
    *   Создать `Router`.
    *   Команда `/checkin` (или кнопка "Чек-ин дня").
    *   FSM для сбора данных (состояние тела, время, настрой).
    *   Использование `decision_engine` для предложения действия.
    *   Отправка предложенного действия пользователю.
    *   Возможность подтверждения или изменения действия.
    *   Фиксация выполнения действия (опционально).
    *   Сохранение записи в `DailyCheckin`.
    *   Подключить роутер `checkin` в `main.py`.

### Этап 6: Статистика и инсайты
13. Реализовать бизнес-логику в `src/fitness_navigator/services/stats_calculator.py`:
    *   Функция получения чек-инов за период (7/30 дней) для пользователя.
    *   Расчёт регулярности (количество дней с активностью).
    *   Распределение по типам действий (тренировка/восстановление/отдых).
    *   Средние значения параметров (body_state, mood).
14. Реализовать `src/fitness_navigator/services/insights.py`:
    *   Анализ паттернов (когда больше энергии, когда меньше).
    *   Генерация коротких смысловых инсайтов.
    *   Форматирование статистики для пользователя.
15. Реализовать `src/fitness_navigator/handlers/stats.py`:
    *   Создать `Router`.
    *   Команда `/stats` (регистрация в роутере).
    *   Формирование и отправка отчета пользователю (используя `stats_calculator` и `insights`).
    *   Подключить роутер `stats` в `main.py`.

### Этап 7: Финализация
16. Проверка кода:
    *   Все тексты бота соответствуют философии (поддерживающие, без давления, см. `docs/product.md`).
    *   Все команды работают корректно.
    *   FSM корректно обрабатывает состояния.
17. Обновление документации:
    *   Проверить актуальность `docs/tech.md` и `docs/product.md`.
    *   Обновить `README.md` при необходимости.

## Риски

*   Ошибки конфигурации Tortoise ORM/Aerich при первом запуске (частая проблема с путями импортов).
*   Ошибки в логике FSM при одновременных запросах или прерванных сессиях онбординга/чек-ина.
*   Сложность отладки правил принятия решений (decision engine) — нужны тестовые сценарии.
*   Несоответствие тональности текстов бота его философии — нужна проверка всех сообщений.

## Стратегия отката

*   В случае критических ошибок на этапе БД: удаление файла `db.sqlite3` и папки `migrations`, повторная инициализация.
*   В случае ошибок кода: откат изменений в git до последнего стабильного коммита.
*   В случае проблем с FSM: сброс состояния через команду `/start` или добавление команды `/cancel` для выхода из FSM.