"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–º—ã—Å–ª–æ–≤—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
"""
from typing import Dict, List
from src.fitness_navigator.database.models import DailyCheckin


def generate_insights(checkins: List[DailyCheckin], stats: Dict) -> List[str]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–º—ã—Å–ª–æ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–µ–∫-–∏–Ω–æ–≤ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    
    Args:
        checkins: –°–ø–∏—Å–æ–∫ —á–µ–∫-–∏–Ω–æ–≤
        stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è calculate_statistics
    
    Returns:
        –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ —Å –∏–Ω—Å–∞–π—Ç–∞–º–∏
    """
    insights = []
    
    if not checkins:
        return ["–ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω—Å–∞–π—Ç–æ–≤. –ü—Ä–æ–¥–æ–ª–∂–∞–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á–µ–∫-–∏–Ω—ã!"]
    
    # –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö)
    if len(checkins) >= 7:
        weekday_energy = {}
        for checkin in checkins:
            weekday = checkin.checkin_date.weekday()
            if weekday not in weekday_energy:
                weekday_energy[weekday] = []
            weekday_energy[weekday].append(checkin.body_state)
        
        # –ù–∞—Ö–æ–¥–∏–º –¥–Ω–∏ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π
        if weekday_energy:
            avg_energy_by_weekday = {
                day: sum(energies) / len(energies)
                for day, energies in weekday_energy.items()
            }
            max_day = max(avg_energy_by_weekday.items(), key=lambda x: x[1])
            min_day = min(avg_energy_by_weekday.items(), key=lambda x: x[1])
            
            weekdays_ru = ["–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤—Ç–æ—Ä–Ω–∏–∫", "—Å—Ä–µ–¥–∞", "—á–µ—Ç–≤–µ—Ä–≥", "–ø—è—Ç–Ω–∏—Ü–∞", "—Å—É–±–±–æ—Ç–∞", "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"]
            if max_day[1] > min_day[1] + 1:  # –†–∞–∑–Ω–∏—Ü–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è
                insights.append(
                    f"–ó–∞–º–µ—Ç–∏–ª, —á—Ç–æ –ø–∏–∫–∏ —ç–Ω–µ—Ä–≥–∏–∏ —É —Ç–µ–±—è —á–∞—â–µ –ø—Ä–∏—Ö–æ–¥—è—Ç—Å—è –Ω–∞ {weekdays_ru[max_day[0]]}. "
                    "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏ —Å—Ç–æ–∏—Ç —É—á–µ—Å—Ç—å –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏."
                )
    
    # –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
    distribution = stats.get("action_distribution", {})
    total = stats.get("total_checkins", 0)
    
    if total > 0:
        workout_pct = (distribution.get("—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", 0) / total) * 100
        recovery_pct = (distribution.get("–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ", 0) / total) * 100
        rest_pct = (distribution.get("–æ—Ç–¥—ã—Ö", 0) / total) * 100
        
        if rest_pct > 50:
            insights.append(
                "–í–∏–∂—É, —á—Ç–æ –æ—Ç–¥—ã—Ö –∑–∞–Ω–∏–º–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é —á–∞—Å—Ç—å —Ç–≤–æ–∏—Ö –¥–Ω–µ–π. "
                "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –≤–∞–∂–Ω–æ —Å–ª—É—à–∞—Ç—å —Å–≤–æ—ë —Ç–µ–ª–æ."
            )
        elif workout_pct > 60:
            insights.append(
                "–ó–∞–º–µ—Ç–∏–ª, —á—Ç–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—Ç –≤ —Ç–≤–æ–∏—Ö —Ä–µ—à–µ–Ω–∏—è—Ö. "
                "–ù–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –≤–∞–∂–Ω–æ."
            )
        elif recovery_pct > 50:
            insights.append(
                "–í–∏–∂—É –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º. "
                "–≠—Ç–æ —Ö–æ—Ä–æ—à–∏–π –ø–æ–¥—Ö–æ–¥ –∫ –∑–∞–±–æ—Ç–µ –æ —Å–µ–±–µ."
            )
    
    # –ê–Ω–∞–ª–∏–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    avg_body_state = stats.get("avg_body_state", 0)
    if avg_body_state > 0:
        if avg_body_state < 5:
            insights.append(
                "–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏ —É —Ç–µ–±—è –¥–æ–≤–æ–ª—å–Ω–æ –Ω–∏–∑–∫–∏–π. "
                "–í–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∂–∏–º —Å–Ω–∞ –∏ –ø–∏—Ç–∞–Ω–∏–µ."
            )
        elif avg_body_state > 7:
            insights.append(
                "–û—Ç–ª–∏—á–Ω–æ, —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏ –¥–æ–≤–æ–ª—å–Ω–æ –≤—ã—Å–æ–∫–∏–π. "
                "–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!"
            )
    
    # –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
    completion_rate = stats.get("completion_rate", 0)
    if completion_rate > 0:
        if completion_rate < 50:
            insights.append(
                "–í–∏–∂—É, —á—Ç–æ –Ω–µ –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è. "
                "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –Ω–µ —Å—Ç–æ–∏—Ç —Å–µ–±—è –∑–∞ —ç—Ç–æ –≤–∏–Ω–∏—Ç—å. "
                "–í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–µ –≤—Å–µ–≥–¥–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é –¥–Ω—è."
            )
        elif completion_rate > 80:
            insights.append(
                "–û—Ç–ª–∏—á–Ω–∞—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è! –í–∏–∂—É, —á—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ö–æ—Ä–æ—à–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç–≤–æ–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º."
            )
    
    # –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –∏–Ω—Å–∞–π—Ç, –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö
    if not insights:
        insights.append(
            "–ü—Ä–æ–¥–æ–ª–∂–∞–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á–µ–∫-–∏–Ω—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. "
            "–°–æ –≤—Ä–µ–º–µ–Ω–µ–º –ø–æ—è–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–≤–æ–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤."
        )
    
    return insights


def format_statistics_message(stats: Dict, insights: List[str]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        insights: –°–ø–∏—Å–æ–∫ –∏–Ω—Å–∞–π—Ç–æ–≤
    
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    """
    if stats["total_checkins"] == 0:
        return "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –ù–∞—á–Ω–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á–µ–∫-–∏–Ω—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!"
    
    distribution = stats.get("action_distribution", {})
    
    message = (
        f"<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {stats.get('days', 7)} –¥–Ω–µ–π</b>\n\n"
        f"<b>–†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å:</b> {stats['regularity']} –¥–Ω–µ–π —Å —á–µ–∫-–∏–Ω–∞–º–∏\n"
        f"<b>–í—Å–µ–≥–æ —á–µ–∫-–∏–Ω–æ–≤:</b> {stats['total_checkins']}\n\n"
        f"<b>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π:</b>\n"
    )
    
    action_names = {
        "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞": "üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏",
        "–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ": "üßò –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ",
        "–æ—Ç–¥—ã—Ö": "üò¥ –û—Ç–¥—ã—Ö"
    }
    
    for action, count in distribution.items():
        action_display = action_names.get(action, action)
        percentage = (count / stats['total_checkins']) * 100
        message += f"‚Ä¢ {action_display}: {count} ({percentage:.1f}%)\n"
    
    message += (
        f"\n<b>–°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:</b>\n"
        f"‚Ä¢ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–ª–∞: {stats['avg_body_state']}/10\n"
        f"‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π: {stats['avg_mood']}/10\n"
        f"‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π: {stats['completion_rate']}% ({stats['completed_count']}/{stats['total_checkins']})\n"
    )
    
    if insights:
        message += "\n<b>üí° –ò–Ω—Å–∞–π—Ç—ã:</b>\n"
        for insight in insights:
            message += f"‚Ä¢ {insight}\n"
    
    return message
