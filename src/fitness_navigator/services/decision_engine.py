"""
Движок принятия решений для предложения действий пользователю
На основе правил из docs/product.md, раздел 7
"""
from typing import Dict, Any
from src.fitness_navigator.database.models import User


def suggest_action(body_state: int, available_time: int, mood: int, user: User = None) -> Dict[str, Any]:
    """
    Предлагает действие на основе параметров чек-ина
    
    Args:
        body_state: Состояние тела (1-10)
        available_time: Доступное время в минутах
        mood: Настрой к активности (1-10)
        user: Пользователь (для учета ограничений)
    
    Returns:
        Словарь с полями:
        - action: "тренировка" | "восстановление" | "отдых"
        - details: Детали действия (строка)
        - reason: Объяснение решения (строка)
    """
    # Проверяем ограничения пользователя
    limitations = user.limitations.lower() if user and user.limitations else ""
    has_pain = "боль" in limitations or "травм" in limitations
    
    # Правило 1: Если состояние низкое (1-3) или настрой низкий (1-3)
    if body_state <= 3 or mood <= 3:
        if has_pain:
            return {
                "action": "отдых",
                "details": "Осознанный отдых. При наличии боли лучше дать телу восстановиться.",
                "reason": "Низкий уровень энергии или настроя, плюс есть ограничения по здоровью."
            }
        if available_time < 20:
            return {
                "action": "отдых",
                "details": "Осознанный отдых. Твое тело сигнализирует, что сил нет. Отдых — это тоже забота о себе.",
                "reason": "Низкое состояние и мало времени."
            }
        else:
            return {
                "action": "восстановление",
                "details": f"{available_time} минут восстановления: прогулка в спокойном темпе или легкая растяжка.",
                "reason": "Низкое состояние, но есть время для мягкого восстановления."
            }
    
    # Правило 2: Если состояние среднее (4-6) и времени мало (<20 минут)
    if 4 <= body_state <= 6 and available_time < 20:
        return {
            "action": "восстановление",
            "details": f"{available_time} минут восстановления: легкая прогулка или растяжка.",
            "reason": "Среднее состояние и мало времени — лучше восстановление, чем нагрузка."
        }
    
    # Правило 3: Если состояние хорошее (7-9) и времени достаточно (>30 минут) и настрой высокий (7-9)
    if 7 <= body_state <= 9 and available_time >= 30 and 7 <= mood <= 9:
        intensity = "интенсивная" if body_state >= 8 and mood >= 8 else "умеренная"
        workout_type = "силовая" if mood >= 8 else "кардио"
        return {
            "action": "тренировка",
            "details": f"{available_time} минут {intensity} {workout_type} тренировки. Используй этот день эффективно.",
            "reason": "Хорошее состояние, достаточно времени и высокий настрой."
        }
    
    # Правило 4: Если состояние отличное (10) и все параметры высокие
    if body_state == 10 and available_time >= 30 and mood >= 9:
        return {
            "action": "тренировка",
            "details": f"{available_time} минут интенсивной тренировки (силовая или кардио на выбор). Отличный день для активной работы!",
            "reason": "Отличное состояние и все параметры высокие."
        }
    
    # Правило 5: Состояние хорошее (7-9), но время среднее или настрой средний
    if 7 <= body_state <= 9:
        if available_time >= 20:
            if mood >= 5:
                return {
                    "action": "тренировка",
                    "details": f"{available_time} минут легкой или умеренной тренировки: зарядка + растяжка.",
                    "reason": "Хорошее состояние и есть время для поддержания тонуса."
                }
            else:
                return {
                    "action": "восстановление",
                    "details": f"{available_time} минут восстановления: прогулка или легкая растяжка.",
                    "reason": "Хорошее состояние, но настроение не готово к нагрузке."
                }
        else:
            return {
                "action": "восстановление",
                "details": f"{available_time} минут восстановления: легкая растяжка или короткая прогулка.",
                "reason": "Хорошее состояние, но времени мало."
            }
    
    # Правило 6: Среднее состояние (4-6), но время достаточно и настрой нормальный
    if 4 <= body_state <= 6 and available_time >= 20 and mood >= 5:
        return {
            "action": "восстановление",
            "details": f"{available_time} минут легкой активности: прогулка, йога или растяжка.",
            "reason": "Среднее состояние — лучше мягкое восстановление, чем интенсивная нагрузка."
        }
    
    # Дефолтный случай: восстановление
    return {
        "action": "восстановление",
        "details": f"{available_time} минут легкого восстановления: прогулка или растяжка.",
        "reason": "Балансируем между активностью и восстановлением."
    }
